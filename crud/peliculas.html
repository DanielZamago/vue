<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://unpkg.com/vue@3"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
     <!-- Alertas -->
     <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
     <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
    <div id="contenedor"> 
        <div class="container">
            <fieldset>
                <h1 v-if="(userRating==false)">
                    All Movies
                </h1>

                <h1 v-else>
                    User Ratings
                </h1>
                    
                <div v-if="(inAction=='mostrarPeliculas')" class="container">
                    <h5 class="flow-text">
                        Welcome: {{email}}
                    </h5>
                    
                    <button v-if="(userRating==true)" @click="action('mostrarPeliculas', null)" class="btn btn-secondary ms-3">
                        Go Back
                    </button>

                    <button v-else @click="ratings" class="btn btn-primary">
                        User Ratings
                    </button>

                    <button @click="logout" class="btn btn-danger ms-4">
                        Logout
                    </button>

                </div>
        
                <div class="container">
                    <hr>
                    <div v-if="(inAction=='mostrarPeliculas')" class="table striped centered bordered">
                        
                        <div class="row row-cols-2 row-cols-md-4 g-5">
                            <div class="" v-for="movie in movies">

                               <a href="">
                                <div class="card ">
                                    <a @click="action('detalles', movie)" class="card">
                                        <img v-bind:src="'https://www.themoviedb.org/t/p/w440_and_h660_face'+movie.poster_path" class="" alt="">
                                    </a>
                                    <div class="card-body">
                                    <h5 class="card-title">{{movie.title}}</h5>
                                    <p class="card-text">{{movie.release_date}}</p>
                                    <p class="card-text">Score: {{movie.vote_average}}</p>
                                    </div>
                                </div>
                               </a>
                                
                            </div>
                        </div>
                        
                    </div>
            
                    <div v-else="(inAction=='detalles')" class="container">

                        <div :style="backgroundDiv" >
                            <div class="row align-items-start ">
                                <div class="col-6">
                                    <img v-bind:src="'https://www.themoviedb.org/t/p/w440_and_h660_face'+this.movie.poster_path" alt="">
                                </div>
                                <div class="col-4 text-aligt-left mt-5" style="color: white;">
                                    <div>
                                        <h5>{{this.movie.title}} ({{year}})</h5> 
                                    </div>
                                    <div>
                                        <h5>User Score: {{movie.vote_average}}</h5>
                                    </div>
                                    <div>
                                        <h5>Overview</h5>
                                        <h6>{{this.movie.overview}}</h6>
                                    </div>  
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="container">
                                <div class="row">
                                    <h5>Status</h5>
                                    <h6>Released</h6>
                                </div>
                                <div class="row">
                                    <h5>Original Lenguage</h5>
                                    <h6>{{this.lenguage}}</h6>
                                </div>
                            </div>
                            <div v-if="(inAction=='valorar')" class="container">
                                <div class="row g-3 align-items-center mt-4">
                                    <div class="col-auto">
                                        <input v-model="valor" type="number" min="1" max="10" class="form-control">
                                    </div>
                                    <div class="col-auto">
                                        <span class="form-text">
                                            Only ratings from 1 to 10.
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <button v-if="(inAction=='valorar')" @click="value" class="btn btn-primary" >
                                    Sent Score
                                </button>
                                <button v-if="(inAction=='valorar')" @click="remove" class="btn btn-danger ms-3">
                                    Delete Score
                                </button>
                                <button v-else @click="action('valorar', movie)" class="btn btn-primary" >
                                    User Score
                                </button>
                                <button @click="action('mostrarPeliculas', null)" class="btn btn-secondary ms-3">
                                    Go Back
                                </button>
                            </div>
                        </div>
                       
                    </div>
                </div>
            </fieldset>
        </div>
    </div>
    
    <script type="text/javascript">
        const {createApp} = Vue;
        
        var app = createApp({
            data(){
                return {
                    account:'',
                    userRating:false,
                    movies:'',
                    movies_Aux:'',
                    movie:'',
                    valor:0,
                    lenguage:'',
                    users:null,
                    year: '',
                    inAction: 'mostrarPeliculas',
                    email: localStorage.getItem('email').toUpperCase(),
                    backgroundDiv : {
                    },  
                }
            },methods : {
                logout(e){
                    e.preventDefault();
                    //borrar info del localStorage
                    localStorage.removeItem('email');
                    window.location="login.html"
                },
                action(a,m){
                    if (a=='mostrarPeliculas') {
                        this.inAction=a;
                        if(this.userRating==true){
                            this.movies=this.movies_Aux
                        }
                        this.userRating=false;

                    }else if(a=='valorar'){
                        this.inAction=a;
                    }else{
                        this.inAction=a;
                        this.year = m.release_date.substring(0,4)
                        this.movie=m;
                        this.inAction=a;
                        if(m.original_language==='en'){
                            this.lenguage='English';
                        }else if(m.original_language=='ja'){
                            this.lenguage='Japanese';
                        }else{
                            this.lenguage='Italian';
                        }
                        this.backgroundDiv = {
                            backgroundImage : 'url(https://www.themoviedb.org/t/p/w440_and_h660_face'+this.movie.backdrop_path+')',
                            backgroundRepeat : 'no-repeat',
                            backgroundSize : '100% 100%',
                        }
                    }
                },
                value(){
                    console.log(this.movie.title);
                    var config = {
                        method: 'post',
                        url: 'https://api.themoviedb.org/3/movie/'+this.movie.id+'/rating?value='+this.valor+'',
                        headers: { 
                            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJmY2Y5OWFkOTVjZWY4YzA1ODdlYmRiNjBlNjhiODBlMSIsInN1YiI6IjYzMWEyMzdjNjJmY2QzMDA3Y2ZhZmUxNSIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.BXC43K6GbCbUbG0RIJWBs3uPCh-bgiRQh2KzAWyBXWQ'
                        }
                    };
                    
                    this.valor=0;
                    this.inAction='mostrarPeliculas'
                    axios(config)
                    .then(function (response) {
                        swal("Reseña enviada exitosamente!", "Presiona 'OK' para continuar!", "success");
                        console.log(JSON.stringify(response.data));
                    })
                    .catch(function (error) {
                        swal("Error al enviar la reseña!", "Presiona 'OK' para continuar!", "error");
                        //console.log(error);
                    });
                },
                ratings(){
                    this.userRating=true
                    this.movies_Aux=this.movies;
                    var self = this;

                    var config = {
                        method: 'get',
                        url: 'https://api.themoviedb.org/3/account',
                        headers: { 
                            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJmY2Y5OWFkOTVjZWY4YzA1ODdlYmRiNjBlNjhiODBlMSIsInN1YiI6IjYzMWEyMzdjNjJmY2QzMDA3Y2ZhZmUxNSIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.BXC43K6GbCbUbG0RIJWBs3uPCh-bgiRQh2KzAWyBXWQ'
                        }
                    };
                    
                    axios(config)
                    .then(function (response) {
                        var json = JSON.stringify(response.data);
                        var arregloAux = JSON.parse(json);
                        self.account= arregloAux;
                        console.log(self.account.id);
                    })
                    .catch(function (error) {
                        console.log(error);
                    });

                    var config = {
                        method: 'get',
                        url: 'https://api.themoviedb.org/3/account/'+this.account.id+'/rated/movies',
                        headers: { 
                            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJmY2Y5OWFkOTVjZWY4YzA1ODdlYmRiNjBlNjhiODBlMSIsInN1YiI6IjYzMWEyMzdjNjJmY2QzMDA3Y2ZhZmUxNSIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.BXC43K6GbCbUbG0RIJWBs3uPCh-bgiRQh2KzAWyBXWQ'
                        }
                    };

                    axios(config)
                    .then(function (response) {
                        console.log(JSON.stringify(response.data));
                        var json = JSON.stringify(response.data.results);
                        console.log(json);
                        var arregloAux = JSON.parse(json);
                        self.movies =  arregloAux
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
                },
                remove(){
                    var borrar = false;
                    swal({
                        title: "Estas seguro?",
                        text: "La valoracion se perdera para siempre",
                        icon: "warning",
                        buttons: true,
                        dangerMode: true,
                        })
                        .then((willDelete) => {
                        if (willDelete) {
                            borrar=true
                            swal("Valoracion eliminada con exito!", "Presiona 'OK' para continuar!", "success");
                            var config = {
                                method: 'delete',
                                url: 'https://api.themoviedb.org/3/movie/'+this.movie.id+'/rating',
                                headers: { 
                                    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJmY2Y5OWFkOTVjZWY4YzA1ODdlYmRiNjBlNjhiODBlMSIsInN1YiI6IjYzMWEyMzdjNjJmY2QzMDA3Y2ZhZmUxNSIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.BXC43K6GbCbUbG0RIJWBs3uPCh-bgiRQh2KzAWyBXWQ'
                                }
                            };
        
                            this.valor=0;
                            this.inAction='mostrarPeliculas'
                            axios(config)
                            .then(function (response) {
                                console.log(JSON.stringify(response.data));
                            })
                            .catch(function (error) {
                                console.log(error);
                            });
                            
                        } else {

                        }
                    });
                }
            },
            mounted(){

                var config = {
                method: 'get',
                url: 'https://api.themoviedb.org/3/movie/popular?&lenguaje=es-MX',
                headers: { 
                    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJmY2Y5OWFkOTVjZWY4YzA1ODdlYmRiNjBlNjhiODBlMSIsInN1YiI6IjYzMWEyMzdjNjJmY2QzMDA3Y2ZhZmUxNSIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.BXC43K6GbCbUbG0RIJWBs3uPCh-bgiRQh2KzAWyBXWQ'
                }
                };
                
                var self = this
                axios(config)
                .then(function (response) {
                //console.log(JSON.stringify(response.data));
                var json = JSON.stringify(response.data.results);
                console.log(json);
                var arregloAux = JSON.parse(json);
                self.movies =  arregloAux
                })
                .catch(function (error) {
                console.log(error);
                });
                
            }

        }).mount('#contenedor')
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</body>
</html>